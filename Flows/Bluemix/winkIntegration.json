[
  {
    "id": "64507875.9baf88",
    "type": "function",
    "name": "",
    "func": "var WinkCMDmsg=\"\";\nif (msg.payload.iftttkey==context.global.IFTTT_TOKEN)\n{\n    if (typeof msg.payload.ifttt !=='undefined')\n    {\n      context.global.ifttt=(msg.payload.ifttt.toLowerCase()==\"on\" ? true:false)\n      msg.res.StatusCode=200;\n    }\n    if (typeof msg.payload.winkName !=='undefined')\n    {\n    node.warn(msg.payload.winkName)\n    if (msg.payload.level !=='undefined')\n    {\n        level=msg.payload.level\n    }  else level=100\n    if (msg.payload.cmd !=='undefined')\n    {\n        cmd=msg.payload.cmd\n    } else cmd=''   \n//    node.warn(level)\n    WinkCMDmsg = context.global.executeWinkCMD(msg.payload.winkName,msg.payload.type,msg.payload.cmd,level)\n    msg.res.StatusCode=200;\n    //node.warn(WinkCMDmsg.payload)\n    }\n}\nelse {\n    node.warn(\"ifttt messages bad request\")\n     msg.res.StatusCode=403;\n}\nif (WinkCMDmsg!==\"\")\n{\n    return [msg,WinkCMDmsg];\n}\nelse\n{\nreturn [msg];\n}",
    "outputs": "2",
    "noerr": 0,
    "x": 343.89581298828125,
    "y": 83.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "58b35580.a74cac"
      ],
      [
        "a1cb00a0.5e35"
      ]
    ]
  },
  {
    "id": "365b5385.c9a4ac",
    "type": "http in",
    "name": "",
    "url": "/red/ifttt",
    "method": "post",
    "swaggerDoc": "",
    "x": 116.89581298828125,
    "y": 83.88894653320312,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "64507875.9baf88"
      ]
    ]
  },
  {
    "id": "58b35580.a74cac",
    "type": "http response",
    "name": "",
    "x": 552.8957977294922,
    "y": 53.888885498046875,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "1dde409d.e221bf",
    "type": "comment",
    "name": "IFTTT Integration-------------------------------------------------------------------------------------------------------------------------------",
    "info": "",
    "x": 427.89581298828125,
    "y": 20.888946533203125,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "a1cb00a0.5e35",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 579.8958129882812,
    "y": 97.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": [
      []
    ]
  },
  {
    "id": "f716613.f08e9a",
    "type": "comment",
    "name": "Wink API Apdex-------------------------------------------------------------------------------------------------------------------------------",
    "info": "",
    "x": 419.89581298828125,
    "y": 136.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "b5118e25.4aee7",
    "type": "inject",
    "name": "",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "repeat": "600",
    "crontab": "",
    "once": true,
    "x": 117.89581298828125,
    "y": 176.88882446289062,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "1e667558.e1998b"
      ]
    ]
  },
  {
    "id": "778d56c1.8872a8",
    "type": "debug",
    "name": "",
    "active": true,
    "console": "true",
    "complete": "payload",
    "x": 830.8958129882812,
    "y": 177.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "1e667558.e1998b",
    "type": "function",
    "name": "",
    "func": "var newMsg ={\n    \"url\":\"http://status.winkapp.com/metrics-display/009ykpcmnm25/day.json\",\n    \"method\":\"GET\",\n    headers: {\n        \"Content-Type\":\"application/json\"\n    }\n};\nreturn newMsg;",
    "outputs": 1,
    "noerr": 0,
    "x": 250.89581298828125,
    "y": 177.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "14b8d208.eb472e"
      ]
    ]
  },
  {
    "id": "14b8d208.eb472e",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 402.89581298828125,
    "y": 177.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "3f6de779.c09218"
      ]
    ]
  },
  {
    "id": "3f6de779.c09218",
    "type": "function",
    "name": "",
    "func": "context.global.winkState.winkAPI = \"\";\nwinkAPI=\"\";\n        for(j = 0; j<msg.payload.metrics[0].data.length; j++)\n        {\n            winkAPI = msg.payload.metrics[0].data[j].value;\n        }\ncontext.global.winkState.winkAPI=winkAPI;\nvar newMsg={\n    payload:\"Wink Apdex is currently: \"+context.global.winkState.winkAPI\n};\nreturn newMsg;",
    "outputs": 1,
    "noerr": 0,
    "x": 685.8958129882812,
    "y": 177.88888549804688,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "778d56c1.8872a8"
      ]
    ]
  },
  {
    "id": "1a75e44d.e58a1c",
    "type": "comment",
    "name": "DromCam/NestCam Integration-------------------------------------------------------------------------------------------------------------------------------",
    "info": "",
    "x": 469.89581298828125,
    "y": 237.38882446289062,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "9f8c58ba.6073a8",
    "type": "comment",
    "name": "Presence  via IFTTT/Tasker/etc. -------------------------------------------------------------------------------------------------------------------------------",
    "info": "",
    "x": 469.39581298828125,
    "y": 338.3888244628906,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "dd6f8513.229078",
    "type": "http in",
    "name": "",
    "url": "/red/presence",
    "method": "post",
    "swaggerDoc": "",
    "x": 149.39581298828125,
    "y": 385.3888244628906,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "ab9676d8.546988"
      ]
    ]
  },
  {
    "id": "ab9676d8.546988",
    "type": "function",
    "name": "Update Presence entry",
    "func": "pr_msg={};\n//if (typeof context.global.PresenceHistory === 'undefined') context.global.PresenceHistory=[]\npr_msg.payload={old_value:context.global.checkPresence()}\nif (msg.payload.iftttkey==context.global.IFTTT_TOKEN)\n{\n    node.warn(msg.payload.name+' '+msg.payload.home)\n    if (typeof(context.global.Presence) === 'undefined'){\n    context.global.Presence = {}\n    } else pr_msg.payload.old_presence=context.global.Presence;\n    if (msg.payload.name !=='undefined'){\n        if (!context.global.Presence[msg.payload.name]) context.global.Presence[msg.payload.name]={}\n            context.global.Presence[msg.payload.name].home=msg.payload.home\n        }\n    msg.res.StatusCode=200;\n    pr_msg.payload.new_value=context.global.checkPresence();\n}\nelse {\n    node.warn(\"presense, bad request\")\n     msg.res.StatusCode=403;\n     pr_msg.payload.new_value='ERROR';\n}\nreturn [msg,pr_msg];",
    "outputs": "2",
    "noerr": 0,
    "x": 385.39581298828125,
    "y": 386.3888244628906,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "fb5f89a9.04a078",
        "394961cd.c6b69e"
      ],
      [
        "2c06c95b.d3f936"
      ]
    ]
  },
  {
    "id": "fb5f89a9.04a078",
    "type": "http response",
    "name": "",
    "x": 816.3957977294922,
    "y": 379.3888244628906,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "2c06c95b.d3f936",
    "type": "function",
    "name": "",
    "func": "var currDate= new Date();\ncurr_presence=context.global.checkPresence()\nif (msg.payload.new_value!=='ERROR' && msg.payload.new_value!==msg.payload.old_value){\n    if('old_presence' in  msg.payload){\n        var HistP={}\n        HistP.timestamp=new Date();\n        HistP.offset=context.global.Weather.Offset\n        HistP.details=msg.payload.old_presence\n        node.warn(HistP)\n        context.global.PresenceHistory.push(HistP)\n    }\n    if (context.global.PresenceHistory.length > 15) context.global.PresenceHistory.pop();\n    var scene_name=(msg.payload.new_value ? 'PRESENCE' : 'NO PRESENCE');\n    for (var key in context.global.winkState.scenes){\n        if ( context.global.winkState.scenes[key].name.toUpperCase()==scene_name)\n        {\n            var newMsg ={\n            \"url\":\"https://winkapi.quirky.com/scenes/\"+context.global.winkState.scenes[key].object_id+\"/activate\",\n            \"method\": \"POST\",\n            headers: {\n                \"Authorization\":\"Bearer \"+context.global.WinkToken,\n                \"Content-Type\":\"application/json\"\n                }\n            }\n        node.send(newMsg)\n        return;\n        }\n    }\n}\nreturn;",
    "outputs": 1,
    "noerr": 0,
    "x": 636.2916107177734,
    "y": 429.6111145019531,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "d3bc13fa.2c43f"
      ]
    ]
  },
  {
    "id": "d3bc13fa.2c43f",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 862.2916107177734,
    "y": 429.7221984863281,
    "z": "54c33433.ab3ccc",
    "wires": [
      []
    ]
  },
  {
    "id": "6ee44320.911bbc",
    "type": "function",
    "name": "",
    "func": "msg.payload={\n    \"thermostats\":context.global.EcobeeThermostats,\n    \"sensor_pods\":context.global.EcobeeSensors\n};\nif (typeof context.global.winkState.thermostats=='undefined'){ context.global.winkState.thermostats = new Object(); }\nfor (var name in msg.payload.thermostats)\n{\n//    node.warn(\"Importing: \"+name+\" thermostat\");\n    context.global.winkState.thermostats[name]={\n        \"name\":name,\n        \"object_type\": msg.payload.thermostats[name].object_type,\n        \"object_id\": msg.payload.thermostats[name].object_id,\n        \"freeboard\": 0,\n        \"connection\": msg.payload.thermostats[name].connection,\n        \"min_set_point\": (msg.payload.thermostats[name].min_set_point-32)*(5/9),\n        \"max_set_point\": (msg.payload.thermostats[name].max_set_point-32)*(5/9),\n        \"mode\": msg.payload.thermostats[name].mode,\n        \"temperature\": (msg.payload.thermostats[name].temperature-32)*(5/9),\n        \"humidity\": msg.payload.thermostats[name].humidity,\n        \"users_away\":false\n    };\n}\n//node.warn(\"Ecobee Thermostat import finished\");\n\nfor (var name in msg.payload.sensor_pods)\n{\n//    node.warn(\"Importing: \"+name+\" sensor pod\");\n    context.global.winkState.sensor_pods[name]={\n        \"name\":name,\n        \"object_type\":msg.payload.sensor_pods[name].object_type,\n        \"object_id\":msg.payload.sensor_pods[name].object_id,\n        \"freeboard\":0,\n    }\n    if (msg.payload.sensor_pods[name].motion==\"true\"){context.global.winkState.sensor_pods[name].motion=true}\n    else if (msg.payload.sensor_pods[name].motion==\"false\"){context.global.winkState.sensor_pods[name].motion=false}\n    context.global.winkDevCap[name]={\n        \"sensor_types\":[{}]\n    }\n    context.global.winkDevCap[name].sensor_types=[{\n            \"field\":\"motion\",\n            \"type\":\"boolean\"\n        }]\n    }\n//node.warn(\"Ecobee Remote Sensor import finished\");\nvar newMsg={\n    \"payload\":\"Ecobee Thermostat and Remote Sensor Data imported successfully\"\n};\nreturn newMsg;",
    "outputs": 1,
    "noerr": 0,
    "x": 280.8958168029785,
    "y": 581.6389236450195,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "96926a4a.696d98"
      ]
    ]
  },
  {
    "id": "38389365.c7c76c",
    "type": "inject",
    "name": "",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "repeat": "",
    "crontab": "",
    "once": false,
    "x": 131.39581298828125,
    "y": 581.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "6ee44320.911bbc"
      ]
    ]
  },
  {
    "id": "96926a4a.696d98",
    "type": "debug",
    "name": "",
    "active": true,
    "console": "false",
    "complete": "false",
    "x": 453.6458282470703,
    "y": 581.6389236450195,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "ae338b7f.51cc78",
    "type": "comment",
    "name": "Integration with Ecobee Node Red ---------------------------------------------------------------------------------------",
    "info": "",
    "x": 383.39581298828125,
    "y": 541.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "253cc7c8.dac338",
    "type": "http in",
    "name": "",
    "url": "/freeboard/camera",
    "method": "get",
    "swaggerDoc": "",
    "x": 174.8957977294922,
    "y": 282.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "7351cb12.8cae34"
      ]
    ]
  },
  {
    "id": "7351cb12.8cae34",
    "type": "function",
    "name": "",
    "func": "if (msg.payload.token==context.global.FREEBOARD_TOKEN)\n{\n   if(typeof msg.payload.model ==='undefined' || msg.payload.model=='dropcam' || msg.payload.model=='dropcam_pro'){\n   if (typeof msg.payload.cuepoint ==='undefined'){\n   msg.url=\"https://winkapi.quirky.com/cameras/\"+msg.payload.id+\"/image\"\n   msg.method=\"GET\"\n    msg.headers= {\n        \"Authorization\":\"Bearer \"+context.global.WinkToken,\n        \"User-Agent\":\"Manufacturer/Darwin node/0.10.30 Wink/3.6.0\"\n    }\n} else\n{\n    msg.url=\"https://winkapi.quirky.com/cameras/\"+msg.payload.id+\"/cuepoints/\"+msg.payload.cuepoint+\"/image\"\n   msg.method=\"GET\"\n    msg.headers= {\n        \"Authorization\":\"Bearer \"+context.global.WinkToken,\n        \"User-Agent\":\"Manufacturer/Darwin node/0.10.30 Wink/3.6.0\"\n}\n}\nreturn msg;\n}\n}\nif (typeof msg.payload.model!=='undefined' && msg.payload.model=='foscam'){\n//http://timothyr.no-ip.org:1882/videostream.cgi?uid=admin&pwd=Dfdbkjy5\nfor (var k in context.global.FosCam){\n    if (context.global.FosCam[k].Parameters.id.value==msg.payload.id){\n     msg.method=\"GET\"\n     msg.url=\"http://\"+context.global.FosCam[k].hostname+\"/videostream.cgi?user=\"+context.global.FosCam[k].uid+\"&pwd=\"+context.global.FosCam[k].pwd\n     node.warn(msg.url);\n    return msg;\n    }\n}\n}\nelse {\n    msg.res.send(400,\"Bad Request darling\");\n}\n",
    "outputs": 1,
    "noerr": 0,
    "x": 428.8957977294922,
    "y": 284.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "bd0cdb14.42f328"
      ]
    ]
  },
  {
    "id": "bd0cdb14.42f328",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "bin",
    "url": "",
    "x": 598.8957977294922,
    "y": 283.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "a2e18dc1.5d1e7"
      ]
    ]
  },
  {
    "id": "a2e18dc1.5d1e7",
    "type": "http response",
    "name": "",
    "x": 763.8957977294922,
    "y": 284.888916015625,
    "z": "54c33433.ab3ccc",
    "wires": []
  },
  {
    "id": "123f3359.edc0cd",
    "type": "function",
    "name": "",
    "func": " var PresenceBkup={\n    Presence: context.global.Presence,\n    PresenceDetail: context.global.PresenceDetail,\n    PresenceHistory: context.global.PresenceHistory\n }\n    var DBMsg={\n        url:context.global.VCAP_SERVICES.cloudantNoSQLDB[0].credentials.url+\"/winkapp\",\n        method:\"POST\",\n        headers: \n            {\n                \"Content-Type\":\"application/json\"\n            },\n        payload: {\n            \"_id\":\"winkPresence\",\n            \"item\":\"Presence\",\n            \"Presence\":PresenceBkup\n        }\n    } \n \n \n if (msg.payload.total_rows > 0  && msg.payload.rows.map(function(e) { return e.id; }).indexOf('winkPresence')!=-1){\n node.warn('record exists... updating');\n //DBMsg.method=\"PUT\";\n DBMsg.payload._rev= msg.payload.rows.map(function(e) {if(e.id==\"winkPresence\") return e.value.rev; })[0];\n }\nreturn DBMsg;",
    "outputs": 1,
    "noerr": 0,
    "x": 896,
    "y": 492,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "1a94cd4e.e56b33"
      ]
    ]
  },
  {
    "id": "394961cd.c6b69e",
    "type": "function",
    "name": "",
    "func": "if (context.global.CloudantBkUP) {\n    var msg={\n        url:context.global.VCAP_SERVICES.cloudantNoSQLDB[0].credentials.url+\"/winkapp/_all_docs\",\n        method:\"GET\"\n    }\n    node.send(msg); \n}\nreturn;",
    "outputs": 1,
    "noerr": 0,
    "x": 572,
    "y": 493,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "98638a0c.679c78"
      ]
    ]
  },
  {
    "id": "98638a0c.679c78",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 736,
    "y": 493,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "123f3359.edc0cd"
      ]
    ]
  },
  {
    "id": "1a94cd4e.e56b33",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 1053,
    "y": 491,
    "z": "54c33433.ab3ccc",
    "wires": [
      []
    ]
  },
  {
    "id": "d29b61b2.2d64a",
    "type": "inject",
    "name": "",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "repeat": "82800",
    "crontab": "",
    "once": true,
    "x": 110.89582824707031,
    "y": 754.2222290039062,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "ff8189b3.007e78"
      ]
    ]
  },
  {
    "id": "ff8189b3.007e78",
    "type": "function",
    "name": "Try to create DB",
    "func": "if (typeof context.global.VCAP_SERVICES!=='undefined' && 'cloudantNoSQLDB' in context.global.VCAP_SERVICES){\n    var DBmsg={\n        url: context.global.VCAP_SERVICES.cloudantNoSQLDB[0].credentials.url+\"/winkapp\",\n        method:\"PUT\"\n    }\n    node.send(DBmsg);\n} else{\nnode.warn('Cloudant credentials are not present. DB backup will be disabled');\ncontext.global.CloudantBkUP=false;\n}\nreturn;",
    "outputs": 1,
    "noerr": 0,
    "x": 297.8958282470703,
    "y": 754.2222290039062,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "495e6187.b6a1a"
      ]
    ]
  },
  {
    "id": "495e6187.b6a1a",
    "type": "http request",
    "name": "db req",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 460.8958282470703,
    "y": 754.2222290039062,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "80af3e0c.7f50c"
      ]
    ]
  },
  {
    "id": "80af3e0c.7f50c",
    "type": "function",
    "name": "Check response",
    "func": "if (msg.statusCode=='201' || msg.statusCode=='412')\n{\n    node.warn('Database created or already exists, turning on backup');\n    context.global.CloudantBkUP=true;\n    msg.url=context.global.VCAP_SERVICES.cloudantNoSQLDB[0].credentials.url+\"/winkapp/winkPresence\"\n    msg.method=\"GET\"\n    node.send(msg)\n} else {\n    node.warn('issue with cloudant sercvice. backup disabled until next re-try');\n    context.global.CloudantBkUP=false;\n}\nreturn;",
    "outputs": 1,
    "noerr": 0,
    "x": 635.8958282470703,
    "y": 754.2222290039062,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "396169f0.c69e96"
      ]
    ]
  },
  {
    "id": "396169f0.c69e96",
    "type": "http request",
    "name": "",
    "method": "use",
    "ret": "obj",
    "url": "",
    "x": 821.7916259765625,
    "y": 753.1111145019531,
    "z": "54c33433.ab3ccc",
    "wires": [
      [
        "51159670.aeea68"
      ]
    ]
  },
  {
    "id": "51159670.aeea68",
    "type": "function",
    "name": "",
    "func": "if (\"Presence\" in msg.payload){\n    node.warn('restoring presence from db backup')\n    context.global.Presence=msg.payload.Presence.Presence\n    context.global.PresenceHistory=msg.payload.Presence.PresenceHistory\n}\nreturn;",
    "outputs": 1,
    "noerr": 0,
    "x": 989.7916259765625,
    "y": 753.1111145019531,
    "z": "54c33433.ab3ccc",
    "wires": [
      []
    ]
  },
  {
    "id": "a4cfefb2.5b301",
    "type": "comment",
    "name": "Cloundant DB -------------------------------------------------------------------------------------------------------------------------------",
    "info": "modfy bluemix-settings.json and add following line:\n\ncontext.global.InitialStateKey=\"<your initial state api key>\"",
    "x": 394.89581298828125,
    "y": 672.2222290039062,
    "z": "54c33433.ab3ccc",
    "wires": []
  }
]